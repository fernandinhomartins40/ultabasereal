name: ğŸš€ Deploy Ultrabase

# Controle de concorrÃªncia
concurrency:
  group: ultrabase-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      full_reinstall:
        description: 'ReinstalaÃ§Ã£o completa (true/false)'
        required: false
        default: 'false'

env:
  VPS_HOST: '82.25.69.57'
  VPS_USER: 'root'
  DEPLOY_DIR: '/opt/supabase-manager'

jobs:
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
      run: |
        echo "ğŸš€ DEPLOY ULTRABASE"
        echo "=================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "ReinstalaÃ§Ã£o completa: ${{ github.event.inputs.full_reinstall || 'false' }}"
        echo "=================="

    - name: ğŸ”‘ Configurar SSH
      run: |
        echo "ğŸ”‘ Configurando SSH..."
        sudo apt-get update && sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ” Verificar Estado da VPS
      id: vps-check
      run: |
        echo "ğŸ” Verificando estado da VPS..."
        
        NEEDS_INSTALL="false"
        NEEDS_DEPS="false"
        APP_RUNNING="false"
        
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== Verificando Sistema ==='
          
          # Verificar dependÃªncias crÃ­ticas
          MISSING=''
          if ! command -v docker >/dev/null 2>&1; then
            echo 'âŒ Docker: NÃƒO INSTALADO'
            MISSING=\"docker \$MISSING\"
          else
            echo \"âœ… Docker: \$(docker --version | cut -d' ' -f1-3)\"
          fi
          
          if ! command -v node >/dev/null 2>&1; then
            echo 'âŒ Node.js: NÃƒO INSTALADO'
            MISSING=\"node \$MISSING\"
          else
            echo \"âœ… Node.js: \$(node --version)\"
          fi
          
          if ! command -v pm2 >/dev/null 2>&1; then
            echo 'âŒ PM2: NÃƒO INSTALADO'
            MISSING=\"pm2 \$MISSING\"
          else
            echo 'âœ… PM2: INSTALADO'
          fi
          
          if ! command -v nginx >/dev/null 2>&1; then
            echo 'âŒ Nginx: NÃƒO INSTALADO'
            MISSING=\"nginx \$MISSING\"
          else
            echo 'âœ… Nginx: INSTALADO'
          fi
          
          # Verificar diretÃ³rio e dependÃªncias
          if [ ! -d '${{ env.DEPLOY_DIR }}' ]; then
            echo 'âŒ DiretÃ³rio da aplicaÃ§Ã£o: NÃƒO EXISTE'
            MISSING=\"dir \$MISSING\"
          else
            echo 'âœ… DiretÃ³rio da aplicaÃ§Ã£o: EXISTE'
            
            if [ ! -d '${{ env.DEPLOY_DIR }}/src/node_modules' ]; then
              echo 'âŒ DependÃªncias Node.js: FALTANDO'
              MISSING=\"deps \$MISSING\"
            else
              echo 'âœ… DependÃªncias Node.js: INSTALADAS'
            fi
            
            # Verificar se app estÃ¡ rodando
            if pm2 list 2>/dev/null | grep -q 'supabase-manager.*online'; then
              echo 'âœ… AplicaÃ§Ã£o: RODANDO'
              APP_RUNNING='true'
            else
              echo 'âŒ AplicaÃ§Ã£o: NÃƒO RODANDO'
            fi
          fi
          
          if [ -n \"\$MISSING\" ]; then
            echo \"NEEDS_INSTALL=true\" > /tmp/deploy_status.txt
          else
            echo \"NEEDS_INSTALL=false\" > /tmp/deploy_status.txt
          fi
          
          echo \"APP_RUNNING=\$APP_RUNNING\" >> /tmp/deploy_status.txt
          echo \"MISSING=\$MISSING\" >> /tmp/deploy_status.txt
        "
        
        # Capturar resultados
        NEEDS_INSTALL=$(sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "grep NEEDS_INSTALL /tmp/deploy_status.txt | cut -d'=' -f2" 2>/dev/null || echo "true")
        APP_RUNNING=$(sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "grep APP_RUNNING /tmp/deploy_status.txt | cut -d'=' -f2" 2>/dev/null || echo "false")
        
        echo "needs_install=$NEEDS_INSTALL" >> $GITHUB_OUTPUT
        echo "app_running=$APP_RUNNING" >> $GITHUB_OUTPUT
        
        echo "ğŸ Precisa instalaÃ§Ã£o: $NEEDS_INSTALL"
        echo "ğŸ App rodando: $APP_RUNNING"

    - name: ğŸ› ï¸ InstalaÃ§Ã£o do Sistema (se necessÃ¡ria)
      if: steps.vps-check.outputs.needs_install == 'true' || github.event.inputs.full_reinstall == 'true'
      run: |
        echo "ğŸ› ï¸ Instalando dependÃªncias do sistema..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          set -e
          export DEBIAN_FRONTEND=noninteractive
          
          # FunÃ§Ã£o para aguardar liberaÃ§Ã£o do apt lock
          wait_for_apt_lock() {
            echo 'â³ Aguardando liberaÃ§Ã£o do apt lock...'
            local max_attempts=30
            local attempt=1
            
            while [ \$attempt -le \$max_attempts ]; do
              if ! lsof /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && ! pgrep -x unattended-upgr >/dev/null 2>&1; then
                echo 'âœ… Apt lock liberado!'
                return 0
              fi
              
              echo \"Tentativa \$attempt/\$max_attempts - Aguardando unattended-upgrades terminar...\"
              sleep 10
              attempt=\$((attempt + 1))
            done
            
            echo 'âš ï¸ Timeout aguardando apt lock - forÃ§ando liberaÃ§Ã£o...'
            # Parar unattended-upgrades se necessÃ¡rio
            systemctl stop unattended-upgrades.service || true
            killall unattended-upgr 2>/dev/null || true
            
            # Remover locks manualmente se necessÃ¡rio
            rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock || true
            dpkg --configure -a || true
            
            return 0
          }
          
          # Aguardar liberaÃ§Ã£o do lock antes de continuar
          wait_for_apt_lock
          
          echo 'ğŸ“¦ Atualizando sistema...'
          apt-get update -y
          apt-get install -y curl wget gnupg2 software-properties-common build-essential jq htop ufw openssl
          
          # Docker
          if ! command -v docker >/dev/null 2>&1; then
            echo 'ğŸ³ Instalando Docker...'
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl start docker
            systemctl enable docker
            rm get-docker.sh
          fi
          
          # Node.js 18
          if ! command -v node >/dev/null 2>&1; then
            echo 'ğŸ“¦ Instalando Node.js 18...'
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            wait_for_apt_lock
            apt-get install -y nodejs
          fi
          
          # PM2
          if ! command -v pm2 >/dev/null 2>&1; then
            echo 'ğŸŒ Instalando PM2...'
            npm install -g pm2
            pm2 startup systemd -u root --hp /root
          fi
          
          # Nginx
          if ! command -v nginx >/dev/null 2>&1; then
            echo 'ğŸŒ Instalando Nginx...'
            wait_for_apt_lock
            apt-get install -y nginx
            
            # ConfiguraÃ§Ã£o bÃ¡sica do Nginx com suporte a subdomÃ­nios
            echo 'server {' > /etc/nginx/sites-available/ultrabase
            echo '    listen 80;' >> /etc/nginx/sites-available/ultrabase
            echo '    server_name ultrabase.com.br www.ultrabase.com.br;' >> /etc/nginx/sites-available/ultrabase
            echo '    ' >> /etc/nginx/sites-available/ultrabase
            echo '    location / {' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_pass http://127.0.0.1:3080;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_http_version 1.1;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_set_header Upgrade \$http_upgrade;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_set_header Connection upgrade;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_set_header Host \$host;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_set_header X-Real-IP \$remote_addr;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_set_header X-Forwarded-Proto \$scheme;' >> /etc/nginx/sites-available/ultrabase
            echo '        proxy_cache_bypass \$http_upgrade;' >> /etc/nginx/sites-available/ultrabase
            echo '    }' >> /etc/nginx/sites-available/ultrabase
            echo '    ' >> /etc/nginx/sites-available/ultrabase
            echo '    location /health {' >> /etc/nginx/sites-available/ultrabase
            echo '        access_log off;' >> /etc/nginx/sites-available/ultrabase
            echo '        return 200 \"healthy\";' >> /etc/nginx/sites-available/ultrabase
            echo '        add_header Content-Type text/plain;' >> /etc/nginx/sites-available/ultrabase
            echo '    }' >> /etc/nginx/sites-available/ultrabase
            echo '}' >> /etc/nginx/sites-available/ultrabase
            
            ln -sf /etc/nginx/sites-available/ultrabase /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default
            # Remover configuraÃ§Ã£o de subdomÃ­nios que nÃ£o funciona sem DNS wildcard
            rm -f /etc/nginx/sites-enabled/ultrabase-instances
            /usr/sbin/nginx -t
            systemctl start nginx
            systemctl enable nginx
          fi
          
          # Garantir configuraÃ§Ã£o correta do Nginx
          echo 'ğŸŒ Configurando Nginx (sempre aplicar)...'
          echo 'server {' > /etc/nginx/sites-available/ultrabase
          echo '    listen 80;' >> /etc/nginx/sites-available/ultrabase
          echo '    server_name ultrabase.com.br www.ultrabase.com.br _;' >> /etc/nginx/sites-available/ultrabase
          echo '    ' >> /etc/nginx/sites-available/ultrabase
          echo '    location / {' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_pass http://127.0.0.1:3080;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_http_version 1.1;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_set_header Upgrade \$http_upgrade;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_set_header Connection \"upgrade\";' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_set_header Host \$host;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_set_header X-Real-IP \$remote_addr;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_set_header X-Forwarded-Proto \$scheme;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_cache_bypass \$http_upgrade;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_connect_timeout 30s;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_send_timeout 30s;' >> /etc/nginx/sites-available/ultrabase
          echo '        proxy_read_timeout 30s;' >> /etc/nginx/sites-available/ultrabase
          echo '    }' >> /etc/nginx/sites-available/ultrabase
          echo '    ' >> /etc/nginx/sites-available/ultrabase
          echo '    location /health {' >> /etc/nginx/sites-available/ultrabase
          echo '        access_log off;' >> /etc/nginx/sites-available/ultrabase
          echo '        return 200 \"healthy\";' >> /etc/nginx/sites-available/ultrabase
          echo '        add_header Content-Type text/plain;' >> /etc/nginx/sites-available/ultrabase
          echo '    }' >> /etc/nginx/sites-available/ultrabase
          echo '}' >> /etc/nginx/sites-available/ultrabase
          
          # Habilitar site e remover default
          ln -sf /etc/nginx/sites-available/ultrabase /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          rm -f /etc/nginx/sites-enabled/ultrabase-instances
          
          # Testar configuraÃ§Ã£o
          if /usr/sbin/nginx -t; then
            echo 'âœ… ConfiguraÃ§Ã£o do Nginx vÃ¡lida'
            systemctl reload nginx || systemctl restart nginx
            echo 'âœ… Nginx recarregado'
          else
            echo 'âŒ Erro na configuraÃ§Ã£o do Nginx'
            /usr/sbin/nginx -t
          fi
          
          # Certificado SSL (se nÃ£o existir)
          if ! command -v certbot >/dev/null 2>&1; then
            echo 'ğŸ”’ Instalando Certbot...'
            wait_for_apt_lock
            apt-get install -y snapd
            snap install core; snap refresh core
            snap install --classic certbot
            ln -sf /snap/bin/certbot /usr/bin/certbot
            
            # Tentar obter certificado (pode falhar se domÃ­nio nÃ£o apontar ainda)
            certbot --nginx --non-interactive --agree-tos --email admin@ultrabase.com.br -d ultrabase.com.br -d www.ultrabase.com.br --redirect || echo 'SSL falhou - domÃ­nio pode nÃ£o estar apontando'
          fi
          
          # Firewall bÃ¡sico
          ufw --force enable
          ufw allow ssh
          ufw allow 80
          ufw allow 443
          
          echo 'âœ… Sistema configurado!'
        "

    - name: ğŸ“¦ Backup dos Dados
      run: |
        echo "ğŸ“¦ Fazendo backup dos dados crÃ­ticos..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          mkdir -p /tmp/ultrabase-backup
          
          # Backup instances.json
          if [ -f '${{ env.DEPLOY_DIR }}/src/instances.json' ]; then
            cp '${{ env.DEPLOY_DIR }}/src/instances.json' /tmp/ultrabase-backup/
            echo 'âœ… instances.json salvo'
          fi
          
          # Backup users.json
          if [ -f '${{ env.DEPLOY_DIR }}/src/users.json' ]; then
            cp '${{ env.DEPLOY_DIR }}/src/users.json' /tmp/ultrabase-backup/
            echo 'âœ… users.json salvo'
          fi
        "

    - name: ğŸ”„ Atualizar CÃ³digo
      run: |
        echo "ğŸ”„ Atualizando cÃ³digo da aplicaÃ§Ã£o..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Criar diretÃ³rio se nÃ£o existe
          mkdir -p ${{ env.DEPLOY_DIR }}
          cd ${{ env.DEPLOY_DIR }}
          
          # Clone ou pull
          if [ ! -d .git ]; then
            echo 'ğŸ†• Clonando repositÃ³rio...'
            git clone https://github.com/fernandinhomartins40/recultrabase.git .
          else
            echo 'ğŸ“¥ Atualizando repositÃ³rio...'
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          fi
          
          # Verificar arquivos crÃ­ticos
          echo 'ğŸ” Verificando arquivos crÃ­ticos...'
          if [ -f 'src/public/index.html' ]; then
            echo 'âœ… index.html encontrado'
            if grep -q 'dashboard-username' src/public/index.html; then
              echo 'âœ… index.html tem campos atualizados'
            else
              echo 'âŒ index.html nÃ£o tem campos atualizados!'
            fi
          else
            echo 'âŒ index.html nÃ£o encontrado!'
          fi
          
          if [ -f 'src/server.js' ]; then
            echo 'âœ… server.js encontrado'
          else
            echo 'âŒ server.js nÃ£o encontrado!'
          fi
          
          if [ -f 'supabase-core/generate.bash' ]; then
            chmod +x supabase-core/generate.bash
            echo 'âœ… generate.bash encontrado e executÃ¡vel'
          else
            echo 'âŒ generate.bash nÃ£o encontrado!'
          fi
          
          # Aplicar permissÃµes
          find supabase-core/ -name '*.bash' -o -name '*.sh' | xargs chmod +x 2>/dev/null || true
        "

    - name: ğŸ”„ Restaurar Dados
      run: |
        echo "ğŸ”„ Restaurando dados preservados..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          mkdir -p src
          
          # Restaurar instances.json
          if [ -f '/tmp/ultrabase-backup/instances.json' ]; then
            cp /tmp/ultrabase-backup/instances.json src/
            echo 'âœ… instances.json restaurado'
          elif [ ! -f 'src/instances.json' ]; then
            echo '{\"instances\": [], \"nextPort\": 8100, \"lastUpdate\": \"'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'\"}' > src/instances.json
            echo 'âœ… instances.json criado'
          fi
          
          # Restaurar users.json
          if [ -f '/tmp/ultrabase-backup/users.json' ]; then
            cp /tmp/ultrabase-backup/users.json src/
            echo 'âœ… users.json restaurado'
          elif [ ! -f 'src/users.json' ]; then
            echo '{\"admin\": {\"id\": \"admin\", \"role\": \"admin\", \"projects\": [\"*\"], \"password_hash\": \"$2b$10$placeholder\"}}' > src/users.json
            echo 'âœ… users.json criado'
          fi
        "

    - name: ğŸ“¦ Instalar DependÃªncias
      run: |
        echo "ğŸ“¦ Instalando dependÃªncias da aplicaÃ§Ã£o..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo 'ğŸ” Debug: Verificando estrutura de diretÃ³rios...'
          echo 'DiretÃ³rio base:'
          ls -la ${{ env.DEPLOY_DIR }}/
          
          echo 'ConteÃºdo do diretÃ³rio src:'
          ls -la ${{ env.DEPLOY_DIR }}/src/ 2>/dev/null || echo 'DiretÃ³rio src nÃ£o existe!'
          
          echo 'Tentando acessar diretÃ³rio src...'
          if [ -d '${{ env.DEPLOY_DIR }}/src' ]; then
            cd ${{ env.DEPLOY_DIR }}/src
            echo 'PWD atual:' \$(pwd)
            echo 'Arquivos no diretÃ³rio atual:'
            ls -la
            
            if [ -f 'package.json' ]; then
              echo 'âœ… package.json encontrado!'
              echo 'ConteÃºdo do package.json:'
              head -5 package.json
              
              echo 'ğŸ“¦ Instalando dependÃªncias...'
              npm install --production --silent
              
              # Verificar instalaÃ§Ã£o
              if [ -d 'node_modules' ] && [ -f 'node_modules/express/package.json' ]; then
                echo 'âœ… DependÃªncias instaladas com sucesso'
              else
                echo 'âŒ Erro na instalaÃ§Ã£o das dependÃªncias'
                exit 1
              fi
            else
              echo 'âŒ package.json nÃ£o encontrado no diretÃ³rio src!'
              exit 1
            fi
          else
            echo 'âŒ DiretÃ³rio src nÃ£o existe!'
            exit 1
          fi
        "

    - name: ğŸš€ Iniciar/Reiniciar AplicaÃ§Ã£o
      run: |
        echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}/src
          
          # Configurar PATH robustamente para incluir Node.js e PM2
          export PATH='/usr/local/bin:/usr/bin:/bin:\$PATH'
          export DEBIAN_FRONTEND=noninteractive
          
          # FunÃ§Ã£o para aguardar liberaÃ§Ã£o do apt lock (caso precise reinstalar Node.js)
          wait_for_apt_lock() {
            echo 'â³ Aguardando liberaÃ§Ã£o do apt lock...'
            local max_attempts=30
            local attempt=1
            
            while [ \$attempt -le \$max_attempts ]; do
              if ! lsof /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && ! pgrep -x unattended-upgr >/dev/null 2>&1; then
                echo 'âœ… Apt lock liberado!'
                return 0
              fi
              
              echo \"Tentativa \$attempt/\$max_attempts - Aguardando unattended-upgrades terminar...\"
              sleep 10
              attempt=\$((attempt + 1))
            done
            
            echo 'âš ï¸ Timeout aguardando apt lock - forÃ§ando liberaÃ§Ã£o...'
            systemctl stop unattended-upgrades.service || true
            killall unattended-upgr 2>/dev/null || true
            rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock || true
            dpkg --configure -a || true
            return 0
          }
          
          # Verificar se Node.js estÃ¡ disponÃ­vel
          echo 'ğŸ” Verificando Node.js...'
          if ! command -v node >/dev/null 2>&1; then
            echo 'âŒ Node.js nÃ£o encontrado no PATH atual'
            echo 'PATH atual: '\$PATH
            
            # Procurar Node.js em locais comuns
            NODE_PATH=''
            for path in '/usr/local/bin/node' '/usr/bin/node' '/opt/nodejs/bin/node'; do
              if [ -x \"\$path\" ]; then
                NODE_PATH=\"\$path\"
                export PATH=\"\$(dirname \$path):\$PATH\"
                echo \"âœ… Node.js encontrado em: \$path\"
                break
              fi
            done
            
            if [ -z \"\$NODE_PATH\" ]; then
              echo 'âŒ Node.js nÃ£o encontrado em lugar nenhum, reinstalando...'
              curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
              wait_for_apt_lock
              apt-get install -y nodejs
              export PATH='/usr/local/bin:/usr/bin:\$PATH'
            fi
          else
            echo \"âœ… Node.js encontrado: \$(node --version)\"
          fi
          
          # Verificar se PM2 estÃ¡ disponÃ­vel
          echo 'ğŸ” Verificando PM2...'
          if ! command -v pm2 >/dev/null 2>&1; then
            echo 'âŒ PM2 nÃ£o encontrado, procurando...'
            PM2_PATH=''
            for path in '/usr/local/bin/pm2' '/usr/bin/pm2' '/root/.npm-global/bin/pm2'; do
              if [ -x \"\$path\" ]; then
                PM2_PATH=\"\$path\"
                export PATH=\"\$(dirname \$path):\$PATH\"
                echo \"âœ… PM2 encontrado em: \$path\"
                break
              fi
            done
            
            if [ -z \"\$PM2_PATH\" ]; then
              echo 'âŒ PM2 nÃ£o encontrado, reinstalando...'
              npm install -g pm2
              export PATH='/usr/local/bin:\$PATH'
            fi
          else
            echo \"âœ… PM2 encontrado: \$(pm2 --version)\"
          fi
          
          # Testar sintaxe do servidor
          echo 'ğŸ” Testando sintaxe do server.js...'
          if node -c server.js; then
            echo 'âœ… Sintaxe do server.js estÃ¡ correta'
          else
            echo 'âŒ Erro de sintaxe no server.js!'
            echo 'ğŸ“‹ Verificando arquivo:'
            ls -la server.js
            echo 'ğŸ“‹ Primeiras linhas:'
            head -10 server.js
            exit 1
          fi
          
          # Parar processo anterior
          echo 'â¹ï¸ Parando processos anteriores...'
          pm2 stop supabase-manager 2>/dev/null || true
          pm2 delete supabase-manager 2>/dev/null || true
          
          # Iniciar aplicaÃ§Ã£o
          echo 'ğŸš€ Iniciando aplicaÃ§Ã£o com PM2...'
          pm2 start server.js --name supabase-manager --log-date-format 'YYYY-MM-DD HH:mm:ss' --time
          pm2 save
          
          echo 'â³ Aguardando estabilizaÃ§Ã£o...'
          sleep 15
          
          # Verificar se ficou online
          if pm2 list | grep -q 'supabase-manager.*online'; then
            echo 'âœ… AplicaÃ§Ã£o iniciada com sucesso'
            pm2 status supabase-manager
          else
            echo 'âŒ AplicaÃ§Ã£o nÃ£o ficou online'
            echo 'ğŸ“‹ Status PM2:'
            pm2 list
            echo 'ğŸ“‹ Logs da aplicaÃ§Ã£o:'
            pm2 logs supabase-manager --lines 30
            exit 1
          fi
        "

    - name: ğŸ” VerificaÃ§Ã£o Final
      run: |
        echo "ğŸ” VerificaÃ§Ã£o final do deploy..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          export PATH='/usr/local/bin:/usr/bin:/bin:\$PATH'
          
          echo '=== Status da AplicaÃ§Ã£o ==='
          pm2 status supabase-manager
          
          echo ''
          echo '=== Teste de Conectividade ==='
          for i in {1..5}; do
            if curl -f -s http://localhost:3080/ >/dev/null 2>&1; then
              echo 'âœ… AplicaÃ§Ã£o responde na porta 3080'
              break
            else
              echo \"â³ Tentativa \$i/5...\"
              sleep 3
            fi
            
            if [ \$i -eq 5 ]; then
              echo 'âŒ AplicaÃ§Ã£o nÃ£o responde apÃ³s 15 segundos'
              pm2 logs supabase-manager --lines 20
            fi
          done
          
          echo ''
          echo '=== Teste via Nginx ==='
          echo 'ğŸ” Testando Nginx diretamente...'
          if curl -f -s http://localhost/ >/dev/null 2>&1; then
            echo 'âœ… Nginx proxy funcionando'
            echo 'ğŸ“‹ Resposta do Nginx:'
            curl -s http://localhost/ | head -10
          else
            echo 'âŒ Problema no Nginx proxy - verificando e corrigindo...'
            echo 'ğŸ“‹ Status do Nginx:'
            systemctl status nginx --no-pager -l || true
            echo 'ğŸ“‹ ConfiguraÃ§Ã£o ativa:'
            ls -la /etc/nginx/sites-enabled/
            echo 'ğŸ“‹ Teste de configuraÃ§Ã£o:'
            /usr/sbin/nginx -t
            
            # Verificar se Nginx estÃ¡ rodando
            if ! systemctl is-active nginx >/dev/null 2>&1; then
              echo 'ğŸ”§ Nginx nÃ£o estÃ¡ ativo, iniciando...'
              systemctl start nginx
              sleep 3
            fi
            
            # Verificar configuraÃ§Ã£o
            if ! /usr/sbin/nginx -t >/dev/null 2>&1; then
              echo 'ğŸ”§ Erro na configuraÃ§Ã£o do Nginx, recriando...'
              echo 'server {' > /etc/nginx/sites-available/ultrabase
              echo '    listen 80;' >> /etc/nginx/sites-available/ultrabase
              echo '    server_name ultrabase.com.br www.ultrabase.com.br;' >> /etc/nginx/sites-available/ultrabase
              echo '    ' >> /etc/nginx/sites-available/ultrabase
              echo '    location / {' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_pass http://127.0.0.1:3080;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_http_version 1.1;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_set_header Upgrade \$http_upgrade;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_set_header Connection upgrade;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_set_header Host \$host;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_set_header X-Real-IP \$remote_addr;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_set_header X-Forwarded-Proto \$scheme;' >> /etc/nginx/sites-available/ultrabase
              echo '        proxy_cache_bypass \$http_upgrade;' >> /etc/nginx/sites-available/ultrabase
              echo '    }' >> /etc/nginx/sites-available/ultrabase
              echo '    ' >> /etc/nginx/sites-available/ultrabase
              echo '    location /health {' >> /etc/nginx/sites-available/ultrabase
              echo '        access_log off;' >> /etc/nginx/sites-available/ultrabase
              echo '        return 200 \"healthy\";' >> /etc/nginx/sites-available/ultrabase
              echo '        add_header Content-Type text/plain;' >> /etc/nginx/sites-available/ultrabase
              echo '    }' >> /etc/nginx/sites-available/ultrabase
              echo '}' >> /etc/nginx/sites-available/ultrabase
              
              # Habilitar site
              ln -sf /etc/nginx/sites-available/ultrabase /etc/nginx/sites-enabled/
              rm -f /etc/nginx/sites-enabled/default
              
              # Testar e recarregar
              if /usr/sbin/nginx -t; then
                systemctl reload nginx
                echo 'âœ… ConfiguraÃ§Ã£o do Nginx corrigida'
              else
                echo 'âŒ Ainda hÃ¡ erro na configuraÃ§Ã£o do Nginx'
                /usr/sbin/nginx -t
              fi
            fi
            
            # Testar novamente apÃ³s correÃ§Ã£o
            sleep 5
            if curl -f -s http://localhost/ >/dev/null 2>&1; then
              echo 'âœ… Nginx proxy funcionando apÃ³s correÃ§Ã£o'
            else
              echo 'âŒ Nginx proxy ainda com problema'
              echo 'ğŸ“‹ Status do Nginx:'
              systemctl status nginx --no-pager -l
              echo 'ğŸ“‹ Logs do Nginx:'
              tail -10 /var/log/nginx/error.log 2>/dev/null || echo 'Sem logs de erro'
            fi
          fi
          
          echo ''
          echo '=== Arquivos CrÃ­ticos ==='
          echo \"index.html: \$([ -f '${{ env.DEPLOY_DIR }}/src/public/index.html' ] && echo 'âœ… OK' || echo 'âŒ MISSING')\"
          echo \"server.js: \$([ -f '${{ env.DEPLOY_DIR }}/src/server.js' ] && echo 'âœ… OK' || echo 'âŒ MISSING')\"
          echo \"generate.bash: \$([ -f '${{ env.DEPLOY_DIR }}/supabase-core/generate.bash' ] && echo 'âœ… OK' || echo 'âŒ MISSING')\"
          
          if [ -f '${{ env.DEPLOY_DIR }}/src/instances.json' ]; then
            INSTANCES=\$(cat '${{ env.DEPLOY_DIR }}/src/instances.json' | jq '.instances | length' 2>/dev/null || echo '0')
            echo \"InstÃ¢ncias preservadas: \$INSTANCES\"
          fi
        "

    - name: ğŸ“Š RelatÃ³rio Final
      if: always()
      run: |
        echo "ğŸ“Š RELATÃ“RIO DO DEPLOY"
        echo "====================="
        echo "Commit: ${{ github.sha }}"
        echo "Timestamp: $(date)"
        echo ""
        echo "ğŸ¯ AplicaÃ§Ã£o: https://ultrabase.com.br/"
        echo "ğŸ”§ Painel: https://ultrabase.com.br/login"
        echo ""
        echo "âœ… Deploy concluÃ­do com sucesso!"

    - name: ğŸ‰ Deploy ConcluÃ­do
      run: |
        echo "ğŸ‰ DEPLOY REALIZADO COM SUCESSO!"
        echo "ğŸ›¡ï¸ Dados preservados: SIM"
        echo "ğŸš€ Sistema: FUNCIONANDO"
        echo ""
        echo "Verifique se a interface mostra os 4 campos no formulÃ¡rio!"